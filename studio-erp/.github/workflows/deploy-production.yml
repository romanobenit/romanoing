name: Deploy to Production

# Trigger su push a main branch (dopo merge PR)
on:
  push:
    branches:
      - main
    paths:
      - 'studio-erp/**'
      - '.github/workflows/deploy-production.yml'
  workflow_dispatch:  # Permette trigger manuale da UI GitHub

env:
  NODE_VERSION: '20'
  ANSIBLE_VERSION: '2.15'

jobs:
  # ═══════════════════════════════════════════════════════
  # JOB 1: Test e Build (CI)
  # ═══════════════════════════════════════════════════════

  test:
    name: Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: studio-erp/package-lock.json

      - name: Install dependencies
        working-directory: studio-erp
        run: npm ci

      - name: Lint code
        working-directory: studio-erp
        run: npm run lint
        continue-on-error: true  # Non blocca deploy per warning lint

      - name: Generate Prisma Client
        working-directory: studio-erp
        run: npx prisma generate

      - name: Build Next.js
        working-directory: studio-erp
        run: npm run build
        env:
          # Build-time env vars (pubbliche)
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: |
            studio-erp/.next
            studio-erp/node_modules
          retention-days: 1

  # ═══════════════════════════════════════════════════════
  # JOB 2: Security Scan (SAST)
  # ═══════════════════════════════════════════════════════

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=studio-erp/package.json
        continue-on-error: true  # Non blocca deploy (solo alert)

      - name: Run npm audit
        working-directory: studio-erp
        run: |
          npm audit --audit-level=high || echo "npm audit found vulnerabilities"
        continue-on-error: true

  # ═══════════════════════════════════════════════════════
  # JOB 3: Deploy con Ansible (CD)
  # ═══════════════════════════════════════════════════════

  deploy:
    name: Deploy to Hetzner
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    environment: production  # Require manual approval (GitHub Environment protection rules)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          ansible --version

      - name: Install Ansible Galaxy collections
        run: |
          ansible-galaxy collection install community.general
          ansible-galaxy collection install community.postgresql
          ansible-galaxy collection install ansible.posix

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PRODUCTION_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Create Ansible Vault password file
        run: |
          echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > studio-erp/ansible/.vault_pass
          chmod 600 studio-erp/ansible/.vault_pass

      - name: Create encrypted vault file
        run: |
          cat > studio-erp/ansible/group_vars/production/vault.yml <<EOF
          ---
          vault_postgresql_password: "${{ secrets.POSTGRESQL_PASSWORD }}"
          vault_nextauth_secret: "${{ secrets.NEXTAUTH_SECRET }}"
          vault_nextauth_url: "https://erp.studioromano.it"
          vault_stripe_publishable_key: "${{ secrets.STRIPE_PUBLISHABLE_KEY }}"
          vault_stripe_secret_key: "${{ secrets.STRIPE_SECRET_KEY }}"
          vault_stripe_webhook_secret: "${{ secrets.STRIPE_WEBHOOK_SECRET }}"
          vault_sendgrid_api_key: "${{ secrets.SENDGRID_API_KEY }}"
          vault_openai_api_key: "${{ secrets.OPENAI_API_KEY }}"
          vault_upstash_redis_rest_url: "${{ secrets.UPSTASH_REDIS_REST_URL }}"
          vault_upstash_redis_rest_token: "${{ secrets.UPSTASH_REDIS_REST_TOKEN }}"
          vault_sentry_dsn: "${{ secrets.SENTRY_DSN }}"
          vault_hetzner_api_token: "${{ secrets.HETZNER_API_TOKEN }}"
          vault_backup_encryption_passphrase: "${{ secrets.BACKUP_ENCRYPTION_PASSPHRASE }}"
          vault_grafana_admin_password: "${{ secrets.GRAFANA_ADMIN_PASSWORD }}"
          EOF

          ansible-vault encrypt studio-erp/ansible/group_vars/production/vault.yml --vault-password-file studio-erp/ansible/.vault_pass

      - name: Update inventory with server IP
        run: |
          sed -i "s/XXX.XXX.XXX.XXX/${{ secrets.PRODUCTION_SERVER_IP }}/g" studio-erp/ansible/inventory/production.yml

      - name: Run Ansible deployment (application only)
        working-directory: studio-erp/ansible
        run: |
          ansible-playbook playbooks/application.yml \
            --vault-password-file .vault_pass \
            --tags deploy \
            -v

      - name: Health check
        run: |
          sleep 10  # Attendi avvio applicazione
          curl --fail --retry 3 --retry-delay 5 https://erp.studioromano.it/api/health

      - name: Notify Sentry deployment
        if: success()
        run: |
          curl -X POST https://sentry.io/api/0/organizations/studio-romano/releases/ \
            -H "Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "${{ github.sha }}",
              "projects": ["studio-erp"],
              "refs": [{
                "repository": "${{ github.repository }}",
                "commit": "${{ github.sha }}"
              }]
            }' || echo "Sentry notification failed (non-blocking)"

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f studio-erp/ansible/.vault_pass
          rm -f studio-erp/ansible/group_vars/production/vault.yml
          rm -f ~/.ssh/id_rsa

  # ═══════════════════════════════════════════════════════
  # JOB 4: Post-Deployment Verification
  # ═══════════════════════════════════════════════════════

  verify:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for application warmup
        run: sleep 15

      - name: Test public endpoints
        run: |
          # Homepage
          curl -f -s -o /dev/null -w "%{http_code}" https://erp.studioromano.it | grep "200"

          # Health check
          curl -f https://erp.studioromano.it/api/health

          # Bundle catalog API (public)
          curl -f https://erp.studioromano.it/api/bundles

      - name: Test SSL/TLS configuration
        run: |
          # Verifica certificato SSL valido
          openssl s_client -connect erp.studioromano.it:443 -servername erp.studioromano.it < /dev/null 2>/dev/null | \
            openssl x509 -noout -dates

          # Verifica TLS 1.2+
          curl -v --tlsv1.2 https://erp.studioromano.it 2>&1 | grep "TLSv1.[23]"

      - name: Test security headers
        run: |
          # HSTS
          curl -s -I https://erp.studioromano.it | grep -i "strict-transport-security"

          # X-Frame-Options
          curl -s -I https://erp.studioromano.it | grep -i "x-frame-options"

          # X-Content-Type-Options
          curl -s -I https://erp.studioromano.it | grep -i "x-content-type-options"

      - name: Run Lighthouse CI (performance)
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://erp.studioromano.it
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ═══════════════════════════════════════════════════════
  # JOB 5: Rollback (solo su fallimento)
  # ═══════════════════════════════════════════════════════

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history per rollback

      - name: Setup Python & Ansible
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: pip install ansible==${{ env.ANSIBLE_VERSION }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PRODUCTION_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Rollback to previous commit
        run: |
          PREVIOUS_COMMIT=$(git rev-parse HEAD~1)
          echo "Rolling back to commit: $PREVIOUS_COMMIT"

          ssh root@${{ secrets.PRODUCTION_SERVER_IP }} << EOF
            cd /var/www/studio-erp
            sudo -u studio git checkout $PREVIOUS_COMMIT
            sudo -u studio npm ci
            sudo -u studio npx prisma generate
            sudo -u studio npm run build
            sudo -u studio pm2 restart studio-erp
          EOF

      - name: Verify rollback
        run: |
          sleep 10
          curl --fail https://erp.studioromano.it/api/health

      - name: Notify team of rollback
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          subject: "⚠️ Production Deployment Failed - Rollback Executed"
          to: benedetto.romano@studioromano.it
          from: deploy@studioromano.it
          body: |
            Deployment to production FAILED and automatic rollback was executed.

            Failed commit: ${{ github.sha }}
            Rolled back to: $(git rev-parse HEAD~1)

            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please investigate logs and fix before retrying deployment.

# ═══════════════════════════════════════════════════════
# Notification (success)
# ═══════════════════════════════════════════════════════

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [verify]
    if: success()

    steps:
      - name: Send success notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          subject: "✅ Production Deployment Successful"
          to: benedetto.romano@studioromano.it
          from: deploy@studioromano.it
          body: |
            Deployment to production completed successfully!

            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Message: ${{ github.event.head_commit.message }}

            Application: https://erp.studioromano.it
            Monitoring: http://${{ secrets.PRODUCTION_SERVER_IP }}:3001 (Grafana)

            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
