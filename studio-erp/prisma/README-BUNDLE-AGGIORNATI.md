# ðŸ“¦ Bundle Aggiornati - Catalogo Completo

Aggiornamento completo del catalogo servizi con 8 bundle ottimizzati.

---

## ðŸŽ¯ Strategia Commerciale

### Consulenza Obbligatoria
- **BDL-CONSULENZA** Ã¨ consigliata prima di ogni bundle
- NON obbligatoria tecnicamente, MA obbligatoria commercialmente
- **Regola**: Nessun incarico strutturato senza consulenza pagata (salvo clienti storici)
- **Benefici**: Migliora conversione, tutela tempo, qualifica lead

---

## ðŸ“‹ Catalogo Completo (8 Bundle)

### 0. ðŸ’¡ Consulenza Tecnica Iniziale
**Codice**: `BDL-CONSULENZA` (NUOVO)

| Campo | Valore |
|-------|--------|
| **Target** | Privato/Investitore/Aziende/PA |
| **Prezzo Privati** | â‚¬180 - â‚¬250 |
| **Prezzo Aziende/PA** | â‚¬300 - â‚¬600 |
| **Durata** | 60-90 minuti |
| **Procedure** | POP-01, POP-07, POP-AI-01 |

**Servizi**:
- âœ… Inquadramento tecnico preliminare
- âœ… Analisi criticitÃ  esistenti
- âœ… Opzioni operative disponibili
- âœ… Suggerimento bundle successivo
- âœ… Report consulenza scritto (opzionale)
- âœ… Registrazione audio/video (opzionale)

**Milestone**:
- **M0** (100%): Pagamento consulenza - Unica soluzione

**Acconto Checkout**:
- Privati: â‚¬215 (media)
- Aziende/PA: â‚¬450 (media)

**Note Strategiche**:
- ðŸŽ¯ Entry point obbligatorio per nuovi clienti
- ðŸ’° Fatturato immediato
- ðŸ§  Qualificazione lead pre-vendita
- â±ï¸ Tutela tempo studio
- ðŸ“ˆ Migliora conversion rate

---

### 1. ðŸ  Ristrutturazione con o senza Bonus
**Codice**: `BDL-RISTR-BONUS` (AGGIORNATO)

| Campo | Valore |
|-------|--------|
| **Target** | Privato/Investitore/Impresa |
| **Prezzo** | â‚¬8.000 - â‚¬18.000 |
| **Durata** | 6-12 mesi |
| **Procedure** | POP-01, POP-02, POP-03, POP-04, POP-07 |

**Servizi**:
- âœ… Rilievo geometrico stato di fatto
- âœ… Progetto architettonico
- âœ… Progetto strutturale
- âœ… Pratica edilizia (CILA/SCIA/PDC)
- âœ… Direzione lavori
- âœ… Asseverazioni bonus edilizi (opzionale)
- âœ… Fine lavori e collaudo

**Milestone**:
1. **M0** (30%): Anticipo - Accettazione incarico
2. **M1** (35%): Progetto approvato - Pratica depositata
3. **M2** (20%): Fine lavori - Chiusura cantiere
4. **M3** (15%): Collaudo finale - Documentazione completa

**Acconto Checkout**: â‚¬3.900 (30% di â‚¬13.000 media)

**Modifiche**:
- âœï¸ Nome cambiato: "con o senza Bonus" (flessibilitÃ )
- âœï¸ Target ampliato: +Investitore, +Impresa
- âœï¸ Bonus diventa opzionale nei servizi

---

### 2. ðŸ” Due Diligence Immobiliare
**Codice**: `BDL-DUE-DILIGENCE` (AGGIORNATO)

| Campo | Valore |
|-------|--------|
| **Target** | Privato/Investitore/Impresa/PA |
| **Prezzo** | â‚¬1.500 - â‚¬4.000 â¬‡ï¸ |
| **Durata** | 2-4 settimane |
| **Procedure** | POP-01, POP-02, POP-03, POP-07 |

**Servizi**:
- âœ… ConformitÃ  edilizia e urbanistica
- âœ… Verifica strutturale preliminare
- âœ… Analisi criticitÃ  energetiche
- âœ… Valutazione rischio amministrativo
- âœ… Verifica documentazione catastale
- âœ… Ispezione tecnica in sito
- âœ… Relazione tecnica due diligence
- âœ… Report fotografico

**Milestone**:
1. **M0** (50%): Anticipo - Avvio attivitÃ 
2. **M1** (50%): Relazione finale - Consegna report completo

**Acconto Checkout**: â‚¬1.375 (50% di â‚¬2.750 media)

**Modifiche**:
- â¬‡ï¸ Prezzo ridotto: â‚¬3.000-â‚¬12.000 â†’ â‚¬1.500-â‚¬4.000 (piÃ¹ competitivo)
- â±ï¸ Durata ridotta: 2 mesi â†’ 2-4 settimane (piÃ¹ veloce)
- ðŸ“Š Milestone semplificate: 3 â†’ 2 (50%/50%)
- ðŸŽ¯ Target ampliato: +Investitore, +PA

---

### 3. ðŸ—ï¸ VulnerabilitÃ  Sismica
**Codice**: `BDL-VULN-SISMICA` (AGGIORNATO)

| Campo | Valore |
|-------|--------|
| **Target** | Condominio/Privato/Impresa/PA |
| **Prezzo** | â‚¬5.000 - â‚¬25.000 |
| **Durata** | 2-4 mesi |
| **Procedure** | POP-01, POP-02, POP-03, POP-07, POP-10 |

**Servizi**:
- âœ… **L0**: Screening preliminare
- âœ… **L1**: Analisi semplificata
- âœ… **L2**: Valutazione completa
- âœ… Rilievo geometrico strutturale
- âœ… Indagini sui materiali
- âœ… Modellazione strutturale FEM
- âœ… Relazione vulnerabilitÃ  sismica
- âœ… Progetto miglioramento/adeguamento
- âœ… Computo metrico estimativo

**Milestone**:
1. **M0** (30%): Anticipo - Avvio attivitÃ 
2. **M1** (30%): Relazione vulnerabilitÃ  - Consegna analisi sismica
3. **M2** (40%): Progetto miglioramento - Progetto definitivo

**Acconto Checkout**: â‚¬4.500 (30% di â‚¬15.000 media)

**Modifiche**:
- ðŸŽ¯ Target ampliato: +Privato, +PA
- ðŸ“Š Servizi strutturati per livelli: L0, L1, L2

---

### 4. ðŸ­ Ampliamento Produttivo
**Codice**: `BDL-AMPLIAMENTO` (AGGIORNATO - CODICE CAMBIATO)

| Campo | Valore |
|-------|--------|
| **Target** | Privato/Impresa/PA |
| **Prezzo** | â‚¬12.000 - â‚¬35.000 â¬†ï¸ |
| **Durata** | 8-18 mesi |
| **Procedure** | POP-01, POP-02, POP-03, POP-04, POP-05, POP-06, POP-07, POP-10 |

**Servizi**:
- âœ… Rilievo edificio esistente
- âœ… Studio di fattibilitÃ  urbanistica
- âœ… Progetto architettonico
- âœ… Progetto strutturale
- âœ… Progetto impianti
- âœ… Pratica edilizia (Permesso Costruire)
- âœ… Direzione lavori
- âœ… ContabilitÃ  lavori
- âœ… Collaudo finale

**Milestone**:
1. **M0** (25%): Anticipo - Avvio progettazione
2. **M1** (30%): Studio fattibilitÃ  - Consegna fattibilitÃ 
3. **M2** (25%): Progetto definitivo - Progetto completo
4. **M3** (20%): Fine lavori - Conclusione DL e collaudo

**Acconto Checkout**: â‚¬5.875 (25% di â‚¬23.500 media)

**Modifiche**:
- ðŸ”„ Codice cambiato: `BDL-AMPL-PRODUTTIVO` â†’ `BDL-AMPLIAMENTO`
- â¬†ï¸ Prezzo aumentato: â‚¬10.000 â†’ â‚¬12.000 (min)
- ðŸŽ¯ Target ampliato: +Privato, +PA
- ðŸ“Š Milestone ristrutturate: 5 â†’ 4 (piÃ¹ snelle)

---

### 5. âœ… Collaudo Statico
**Codice**: `BDL-COLLAUDO` (AGGIORNATO - CODICE CAMBIATO)

| Campo | Valore |
|-------|--------|
| **Target** | Privato/Impresa/PA |
| **Prezzo** | â‚¬2.500 - â‚¬12.000 â¬‡ï¸ |
| **Durata** | 1-3 mesi |
| **Procedure** | POP-05, POP-07 |

**Servizi**:
- âœ… Verifica documentazione strutturale
- âœ… Esame elaborati as-built
- âœ… Sopralluogo cantiere
- âœ… Controllo materiali e certificati
- âœ… Prove di carico (se necessarie)
- âœ… Verifiche geometriche
- âœ… Relazione collaudo statico
- âœ… Certificato regolare esecuzione
- âœ… Deposito Genio Civile

**Milestone**:
1. **M0** (40%): Anticipo - Accettazione incarico
2. **M1** (30%): Sopralluogo e verifiche - Completamento ispezioni
3. **M2** (30%): Relazione e deposito - Consegna certificato

**Acconto Checkout**: â‚¬2.900 (40% di â‚¬7.250 media)

**Modifiche**:
- ðŸ”„ Codice cambiato: `BDL-COLLAUDO-STATICO` â†’ `BDL-COLLAUDO` (piÃ¹ semplice)
- â¬‡ï¸ Prezzo ridotto: â‚¬15.000 â†’ â‚¬12.000 (max)
- ðŸŽ¯ Target cambiato: Condominio â†’ Privato/Impresa/PA (piÃ¹ ampio)

---

### 6. ðŸ”¥ Antincendio
**Codice**: `BDL-ANTINCENDIO` (AGGIORNATO)

| Campo | Valore |
|-------|--------|
| **Target** | Privato/Impresa/PA |
| **Prezzo** | â‚¬2.000 - â‚¬8.000 |
| **Durata** | 2-4 mesi |
| **Procedure** | POP-01, POP-02, POP-03, POP-07 |

**Servizi**:
- âœ… Valutazione rischio incendio (D.M. 03/09/2021)
- âœ… Progetto antincendio
- âœ… Elaborati grafici (planimetrie, sezioni)
- âœ… SCIA antincendio VVF
- âœ… Assistenza sopralluogo VVF
- âœ… Certificato Prevenzione Incendi (CPI)

**Milestone**:
1. **M0** (40%): Anticipo - Avvio progettazione
2. **M1** (40%): Progetto e SCIA - Deposito pratica VVF
3. **M2** (20%): Chiusura pratica - Ottenimento CPI

**Acconto Checkout**: â‚¬2.000 (40% di â‚¬5.000 media)

**Modifiche**:
- ðŸŽ¯ Target ampliato: Azienda â†’ Privato/Impresa/PA

---

### 7. âš¡ Efficientamento Energetico
**Codice**: `BDL-EFF-ENERGETICO` (NUOVO)

| Campo | Valore |
|-------|--------|
| **Target** | Privato/Impresa/PA |
| **Prezzo** | â‚¬2.500 - â‚¬8.000 |
| **Durata** | 1-3 mesi |
| **Procedure** | POP-01, POP-02, POP-03, POP-07 |

**Servizi**:
- âœ… Diagnosi energetica edificio
- âœ… APE (Attestato Prestazione Energetica)
- âœ… Scenari di intervento migliorativo
- âœ… Analisi costi/benefici
- âœ… Valutazione incentivi disponibili
- âœ… Progetto preliminare interventi
- âœ… Relazione tecnica completa

**Milestone**:
1. **M0** (40%): Anticipo - Avvio diagnosi
2. **M1** (60%): Relazione finale - Consegna APE e scenari

**Acconto Checkout**: â‚¬2.100 (40% di â‚¬5.250 media)

**Note Strategiche**:
- ðŸŒ± Bundle nuovo per cogliere trend sostenibilitÃ 
- ðŸ’° Prezzo competitivo per mercato crescente
- ðŸ“Š 2 milestone (semplice e veloce)
- ðŸŽ¯ Target universale (tutti i settori)

---

## ðŸ“Š Confronto Prima/Dopo

| # | Codice Vecchio | Codice Nuovo | Prezzo Vecchio | Prezzo Nuovo | Note |
|---|----------------|--------------|----------------|--------------|------|
| 0 | - | **BDL-CONSULENZA** | - | â‚¬180-â‚¬600 | ðŸ†• NUOVO |
| 1 | BDL-RISTR-BONUS | BDL-RISTR-BONUS | â‚¬8k-â‚¬18k | â‚¬8k-â‚¬18k | Nome aggiornato |
| 2 | BDL-DUE-DILIGENCE | BDL-DUE-DILIGENCE | â‚¬3k-â‚¬12k | â‚¬1.5k-â‚¬4k | â¬‡ï¸ Prezzo ridotto |
| 3 | BDL-VULN-SISMICA | BDL-VULN-SISMICA | â‚¬5k-â‚¬25k | â‚¬5k-â‚¬25k | Target ampliato |
| 4 | **BDL-AMPL-PRODUTTIVO** | **BDL-AMPLIAMENTO** | â‚¬10k-â‚¬35k | â‚¬12k-â‚¬35k | ðŸ”„ Codice cambiato |
| 5 | **BDL-COLLAUDO-STATICO** | **BDL-COLLAUDO** | â‚¬2.5k-â‚¬15k | â‚¬2.5k-â‚¬12k | ðŸ”„ Codice cambiato |
| 6 | BDL-ANTINCENDIO | BDL-ANTINCENDIO | â‚¬2k-â‚¬8k | â‚¬2k-â‚¬8k | Target ampliato |
| 7 | - | **BDL-EFF-ENERGETICO** | - | â‚¬2.5k-â‚¬8k | ðŸ†• NUOVO |

**Totale**: 6 bundle â†’ **8 bundle** (+2 nuovi)

---

## ðŸ”§ Installazione

### âš ï¸ IMPORTANTE: Backup Prima di Aggiornare

```sql
-- Backup tabella bundle
CREATE TABLE bundle_backup_20251227 AS SELECT * FROM bundle;

-- Backup incarichi collegati
CREATE TABLE incarichi_backup_20251227 AS
SELECT * FROM incarichi WHERE bundle_id IN (SELECT id FROM bundle);
```

### Opzione 1: Script NPM (Consigliato)

```bash
cd studio-erp

# Esegui aggiornamento
npm run db:update-bundle

# Oppure manuale:
psql $DATABASE_URL -f prisma/update-bundle-completo.sql
```

### Opzione 2: psql Diretto

```bash
export DATABASE_URL="postgresql://user:password@localhost:5432/studio_erp"
psql $DATABASE_URL -f studio-erp/prisma/update-bundle-completo.sql
```

### Opzione 3: pgAdmin/DataGrip

1. Apri `update-bundle-completo.sql`
2. Copia contenuto
3. Esegui nel query editor
4. Verifica output

---

## âœ… Verifica Installazione

### 1. Conta Bundle

```sql
SELECT COUNT(*) as totale_bundle FROM bundle WHERE attivo = true;
-- Risultato atteso: 8
```

### 2. Verifica Tutti i Bundle

```sql
SELECT
  codice,
  nome,
  target,
  prezzo_min || ' - ' || prezzo_max as prezzo,
  durata_mesi,
  attivo
FROM bundle
ORDER BY codice;
```

### 3. Verifica Milestone (devono sommare 100%)

```sql
SELECT
  codice,
  nome,
  (
    SELECT SUM((m->>'percentuale')::numeric)
    FROM jsonb_array_elements(milestone) AS m
  ) as totale_percentuale
FROM bundle;
-- Tutte devono essere 100.00
```

### 4. Verifica Codici Cambiati

```sql
-- Questi NON devono esistere piÃ¹
SELECT COUNT(*) FROM bundle WHERE codice IN ('BDL-AMPL-PRODUTTIVO', 'BDL-COLLAUDO-STATICO');
-- Risultato atteso: 0

-- Questi DEVONO esistere
SELECT COUNT(*) FROM bundle WHERE codice IN ('BDL-AMPLIAMENTO', 'BDL-COLLAUDO');
-- Risultato atteso: 2
```

---

## ðŸ§ª Testing Frontend

### 1. Checkout Page

```
http://localhost:3000/checkout
```

**Verifica**:
- âœ… Dropdown mostra 8 bundle
- âœ… BDL-CONSULENZA presente (primo della lista idealmente)
- âœ… BDL-AMPLIAMENTO e BDL-COLLAUDO presenti
- âœ… NO BDL-AMPL-PRODUTTIVO e BDL-COLLAUDO-STATICO
- âœ… Prezzi aggiornati visibili

### 2. Nuovo Incarico (Collaboratore)

```
http://localhost:3000/collaboratore/incarichi
```

- Click "Nuovo Incarico"
- Verifica dropdown bundle aggiornato

### 3. API Bundle

```bash
# Lista completa
curl http://localhost:3000/api/bundle

# Consulenza (nuovo)
curl http://localhost:3000/api/bundle/BDL-CONSULENZA

# Efficientamento (nuovo)
curl http://localhost:3000/api/bundle/BDL-EFF-ENERGETICO

# Ampliamento (codice cambiato)
curl http://localhost:3000/api/bundle/BDL-AMPLIAMENTO

# Verifica vecchi codici NON funzionano
curl http://localhost:3000/api/bundle/BDL-AMPL-PRODUTTIVO
# Deve ritornare errore 404
```

---

## ðŸ”„ Rollback (Se Necessario)

Se qualcosa va storto, ripristina dal backup:

```sql
-- Ripristina bundle
DELETE FROM bundle;
INSERT INTO bundle SELECT * FROM bundle_backup_20251227;

-- Ripristina incarichi (se necessario)
DELETE FROM incarichi WHERE bundle_id NOT IN (SELECT id FROM bundle);
INSERT INTO incarichi
SELECT * FROM incarichi_backup_20251227
WHERE id NOT IN (SELECT id FROM incarichi);
```

---

## ðŸ“ Note Implementative

### Codici Bundle Cambiati

**Prima**:
- `BDL-AMPL-PRODUTTIVO` â†’ `BDL-AMPLIAMENTO`
- `BDL-COLLAUDO-STATICO` â†’ `BDL-COLLAUDO`

**Impatto**:
- âš ï¸ Incarichi esistenti con vecchi codici potrebbero avere problemi
- âœ… Lo script DELETE rimuove i vecchi, INSERT crea i nuovi
- ðŸ”„ Se hai incarichi attivi, considera di NON eseguire il DELETE

### Gestione Incarichi Esistenti

**Scenario 1 - Database Pulito** (seed/dev):
- âœ… Esegui script completo (DELETE + INSERT)
- Nessun problema

**Scenario 2 - Incarichi in Corso**:
- âš ï¸ Commenta la sezione DELETE nello script
- âœ… Esegui solo INSERT dei nuovi bundle
- ðŸ”§ Aggiorna manualmente i vecchi con UPDATE:

```sql
-- Aggiorna bundle esistenti
UPDATE bundle SET
  nome = 'Ampliamento Produttivo',
  prezzo_min = 12000,
  target = 'privato',
  -- ... altri campi
WHERE codice = 'BDL-AMPL-PRODUTTIVO';

-- Poi rinomina codice
UPDATE bundle SET codice = 'BDL-AMPLIAMENTO'
WHERE codice = 'BDL-AMPL-PRODUTTIVO';
```

### Durata Bundle in Mesi

| Bundle | Durata Reale | Mesi DB | Note |
|--------|--------------|---------|------|
| Consulenza | 60-90 min | 0.033 | ~1 giorno |
| Due Diligence | 2-4 settimane | 1 | ~1 mese |
| Collaudo | 1-3 mesi | 2 | Media |
| VulnerabilitÃ  | 2-4 mesi | 3 | Media |
| Antincendio | 2-4 mesi | 3 | Media |
| Efficientamento | 1-3 mesi | 2 | Media |
| Ristrutturazione | 6-12 mesi | 9 | Media |
| Ampliamento | 8-18 mesi | 13 | Media |

---

## ðŸŽ¯ Strategy Playbook

### Funnel Consigliato

1. **Lead arriva** â†’ Proponi `BDL-CONSULENZA`
2. **Consulenza pagata** â†’ Durante consulenza:
   - Analizza situazione
   - Suggerisci bundle appropriato
   - Converti in incarico strutturato
3. **Incarico firmato** â†’ Processo normale

### Eccezioni

**Clienti Storici**:
- Possono saltare consulenza
- A discrezione studio

**Grandi Progetti**:
- Consulenza â‚¬600 (fascia alta)
- Maggiore impegno pre-vendita

**Piccoli Privati**:
- Consulenza â‚¬180-â‚¬250
- Veloce e qualificante

---

## ðŸ› Troubleshooting

### Bundle non appare in dropdown

1. Verifica attivo:
   ```sql
   SELECT codice, attivo FROM bundle;
   ```

2. Restart server:
   ```bash
   npm run dev
   ```

3. Clear cache browser (Ctrl+Shift+R)

### Errore "codice giÃ  esistente"

- Lo script usa DELETE prima di INSERT
- Se errore persiste, verifica duplicati:
  ```sql
  SELECT codice, COUNT(*) FROM bundle GROUP BY codice HAVING COUNT(*) > 1;
  ```

### Milestone non sommano 100%

Verifica:
```sql
SELECT
  codice,
  (SELECT SUM((m->>'percentuale')::numeric) FROM jsonb_array_elements(milestone) AS m) as tot
FROM bundle
WHERE (SELECT SUM((m->>'percentuale')::numeric) FROM jsonb_array_elements(milestone) AS m) != 100;
```

---

## ðŸ“š Riferimenti

- Schema database: `prisma/schema.sql`
- API Bundle: `app/api/bundle/route.ts`
- Checkout: `app/api/checkout/create-session/route.ts`
- Webhook: `app/api/cliente/pagamenti/webhook/route.ts`

---

**Creato**: 2025-12-27
**Versione**: 2.0
**Bundle Totali**: 8 (2 nuovi, 6 aggiornati)
**Breaking Changes**: Codici cambiati (AMPL-PRODUTTIVO â†’ AMPLIAMENTO, COLLAUDO-STATICO â†’ COLLAUDO)
