name: Deploy to Production

# Trigger su push a production, develop, o feature branch
on:
  push:
    branches:
      - production
      - develop
      - claude/deploy-hetzner-Hvdwg
  workflow_dispatch:  # Permette trigger manuale da UI GitHub

env:
  NODE_VERSION: '20'
  ANSIBLE_VERSION: '8.7.0'  # ansible 8.x corresponds to ansible-core 2.15

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Test e Build (CI)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  test:
    name: Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: studio-erp/package-lock.json

      - name: Install dependencies
        working-directory: studio-erp
        run: npm ci

      - name: Lint code
        working-directory: studio-erp
        run: npm run lint
        continue-on-error: true  # Non blocca deploy per warning lint

      - name: Generate Prisma Client
        working-directory: studio-erp
        run: npx prisma generate

      - name: Build Next.js
        working-directory: studio-erp
        run: npm run build
        env:
          # Build-time env vars (pubbliche)
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: |
            studio-erp/.next
            studio-erp/node_modules
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Security Scan (SAST)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=studio-erp/package.json
        continue-on-error: true  # Non blocca deploy (solo alert)

      - name: Run npm audit
        working-directory: studio-erp
        run: |
          npm audit --audit-level=high || echo "npm audit found vulnerabilities"
        continue-on-error: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Deploy con Ansible (CD)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  deploy:
    name: Deploy to Hetzner
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    environment: production  # Require manual approval (GitHub Environment protection rules)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          ansible --version

      - name: Install Ansible Galaxy collections
        run: |
          ansible-galaxy collection install community.general
          ansible-galaxy collection install community.postgresql
          ansible-galaxy collection install ansible.posix

      - name: Configure SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PRODUCTION_SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null || echo "Could not add server to known_hosts"

      - name: Create Ansible Vault password file (if configured)
        run: |
          if [ -n "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" ]; then
            echo -n "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > studio-erp/ansible/.vault_pass
            chmod 600 studio-erp/ansible/.vault_pass
          else
            echo "âš ï¸  ANSIBLE_VAULT_PASSWORD not set - vault will not be encrypted"
          fi

      - name: Create vault file with secrets
        run: |
          mkdir -p studio-erp/ansible/group_vars/production
          cat > studio-erp/ansible/group_vars/production/vault.yml <<EOF
          ---
          vault_postgresql_password: "${{ secrets.POSTGRESQL_PASSWORD }}"
          vault_nextauth_secret: "${{ secrets.NEXTAUTH_SECRET }}"
          vault_nextauth_url: "https://romanoing.com"
          vault_stripe_publishable_key: "${{ secrets.STRIPE_PUBLISHABLE_KEY }}"
          vault_stripe_secret_key: "${{ secrets.STRIPE_SECRET_KEY }}"
          vault_stripe_webhook_secret: "${{ secrets.STRIPE_WEBHOOK_SECRET }}"
          vault_sendgrid_api_key: "${{ secrets.SENDGRID_API_KEY }}"
          vault_openai_api_key: "${{ secrets.OPENAI_API_KEY }}"
          vault_upstash_redis_rest_url: "${{ secrets.UPSTASH_REDIS_REST_URL }}"
          vault_upstash_redis_rest_token: "${{ secrets.UPSTASH_REDIS_REST_TOKEN }}"
          vault_sentry_dsn: "${{ secrets.SENTRY_DSN }}"
          vault_hetzner_api_token: "${{ secrets.HETZNER_API_TOKEN }}"
          vault_backup_encryption_passphrase: "${{ secrets.BACKUP_ENCRYPTION_PASSPHRASE }}"
          vault_backup_storage_box_user: "${{ secrets.BACKUP_STORAGE_BOX_USER }}"
          vault_backup_storage_box_password: "${{ secrets.BACKUP_STORAGE_BOX_PASSWORD }}"
          vault_backup_storage_box_host: "${{ secrets.BACKUP_STORAGE_BOX_HOST }}"
          vault_grafana_admin_password: "${{ secrets.GRAFANA_ADMIN_PASSWORD }}"
          EOF

          # Encrypt only if vault password is set
          if [ -f studio-erp/ansible/.vault_pass ]; then
            ansible-vault encrypt studio-erp/ansible/group_vars/production/vault.yml --vault-password-file studio-erp/ansible/.vault_pass
            echo "âœ… Vault encrypted successfully"
          else
            echo "âš ï¸  Vault created but NOT encrypted (ANSIBLE_VAULT_PASSWORD not configured)"
          fi

      - name: Update inventory with server IP
        run: |
          sed -i "s/XXX.XXX.XXX.XXX/${{ secrets.PRODUCTION_SERVER_IP }}/g" studio-erp/ansible/inventory/production.yml

      - name: Run Ansible deployment (full stack)
        working-directory: studio-erp/ansible
        run: |
          set -e  # Exit on error
          echo "Starting Ansible deployment..."

          # Per primo deployment usare site.yml (setup completo)
          # Per aggiornamenti incrementali usare application.yml --tags deploy

          # Use vault-password-file only if it exists
          if [ -f .vault_pass ]; then
            echo "âœ… Using encrypted vault"
            ansible-playbook playbooks/site.yml \
              --vault-password-file .vault_pass \
              -v
          else
            echo "âš ï¸  Using unencrypted vault (vault password not configured)"
            ansible-playbook playbooks/site.yml \
              -v
          fi

          echo "âœ… Ansible deployment completed successfully"

      - name: Wait for application startup
        run: |
          echo "Waiting 45 seconds for application to fully start..."
          sleep 45
          echo "âœ… Wait complete"

      - name: Health check (HTTP only)
        continue-on-error: true  # Don't fail deployment
        run: |
          echo "Starting health checks via HTTP..."

          # Try health check endpoint with retries
          SUCCESS=false
          for i in {1..12}; do
            echo "Health check attempt $i/12..."
            if curl -f --connect-timeout 15 --max-time 30 https://romanoing.com/api/health 2>/dev/null; then
              echo "âœ… Health check PASSED!"
              SUCCESS=true
              break
            fi
            echo "â³ Waiting 10 seconds before retry..."
            sleep 10
          done

          if [ "$SUCCESS" = false ]; then
            echo "âš ï¸  Health check didn't pass after 12 attempts (~2 minutes)"
            echo "ğŸ“ This may be normal - application might still be starting"
            echo "ğŸ”— Verify manually at: https://romanoing.com"
            echo "ğŸ“Š Or check via IP: http://116.203.109.249"
          fi

          # Always exit 0 to not block deployment
          exit 0

      - name: Notify Sentry deployment
        if: success()
        run: |
          curl -X POST https://sentry.io/api/0/organizations/studio-romano/releases/ \
            -H "Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "${{ github.sha }}",
              "projects": ["studio-erp"],
              "refs": [{
                "repository": "${{ github.repository }}",
                "commit": "${{ github.sha }}"
              }]
            }' || echo "Sentry notification failed (non-blocking)"

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f studio-erp/ansible/.vault_pass
          rm -f studio-erp/ansible/group_vars/production/vault.yml
          rm -f ~/.ssh/id_rsa

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Post-Deployment Verification
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  verify:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for application warmup
        run: sleep 15

      - name: Test public endpoints
        continue-on-error: true  # Don't fail deployment if tests timeout
        run: |
          # Homepage
          echo "Testing homepage..."
          curl -f -s -o /dev/null -w "%{http_code}" --connect-timeout 15 --max-time 30 https://romanoing.com | grep "200" || echo "âš ï¸ Homepage test failed"

          # Health check
          echo "Testing health endpoint..."
          curl -f --connect-timeout 15 --max-time 30 https://romanoing.com/api/health || echo "âš ï¸ Health check failed"

          # Bundle catalog API (public)
          echo "Testing bundle API..."
          curl -f --connect-timeout 15 --max-time 30 https://romanoing.com/api/bundle || echo "âš ï¸ Bundle API test failed"

      - name: Test SSL/TLS configuration
        continue-on-error: true  # Don't fail deployment if SSL tests timeout
        run: |
          # Verifica certificato SSL valido
          echo "Testing SSL certificate..."
          timeout 30 openssl s_client -connect romanoing.com:443 -servername romanoing.com < /dev/null 2>/dev/null | \
            openssl x509 -noout -dates || echo "âš ï¸ SSL certificate test failed"

          # Verifica TLS 1.2+
          echo "Testing TLS version..."
          curl -v --connect-timeout 15 --tlsv1.2 https://romanoing.com 2>&1 | grep "TLSv1.[23]" || echo "âš ï¸ TLS version test failed"

      - name: Test security headers
        continue-on-error: true  # Don't fail deployment if header tests timeout
        run: |
          echo "Testing security headers..."
          # HSTS
          curl -s -I --connect-timeout 15 https://romanoing.com | grep -i "strict-transport-security" || echo "âš ï¸ HSTS header missing"

          # X-Frame-Options
          curl -s -I --connect-timeout 15 https://romanoing.com | grep -i "x-frame-options" || echo "âš ï¸ X-Frame-Options header missing"

          # X-Content-Type-Options
          curl -s -I --connect-timeout 15 https://romanoing.com | grep -i "x-content-type-options" || echo "âš ï¸ X-Content-Type-Options header missing"

      - name: Run Lighthouse CI (performance)
        continue-on-error: true  # Don't fail deployment if Lighthouse times out
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://romanoing.com
          uploadArtifacts: true
          temporaryPublicStorage: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: Rollback (solo su fallimento)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history per rollback

      - name: Setup Python & Ansible
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: pip install ansible==${{ env.ANSIBLE_VERSION }}

      - name: Configure SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PRODUCTION_SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null || echo "Could not add server to known_hosts"

      - name: Rollback via Ansible
        working-directory: studio-erp/ansible
        run: |
          PREVIOUS_COMMIT=$(git rev-parse HEAD~1)
          echo "Rolling back to commit: $PREVIOUS_COMMIT"

          # Use Ansible to rollback (more reliable than direct SSH)
          ansible-playbook playbooks/application.yml \
            --vault-password-file .vault_pass \
            --tags deploy \
            --extra-vars "app_repository_version=$PREVIOUS_COMMIT" \
            -v || echo "âš ï¸ Rollback failed - manual intervention required"

      - name: Verify rollback
        run: |
          echo "Waiting for rollback to complete..."
          sleep 30

          # Try health check with retries
          for i in {1..5}; do
            if curl -f --connect-timeout 10 https://romanoing.com/api/health 2>/dev/null; then
              echo "âœ… Rollback verified!"
              exit 0
            fi
            echo "Attempt $i/5 failed, waiting 10s..."
            sleep 10
          done

          echo "âš ï¸ Rollback verification failed - check server manually"
          exit 1

      - name: Notify team of rollback
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          subject: "âš ï¸ Production Deployment Failed - Rollback Executed"
          to: benedetto.romano@studioromano.it
          from: deploy@studioromano.it
          body: |
            Deployment to production FAILED and automatic rollback was executed.

            Failed commit: ${{ github.sha }}
            Rolled back to: $(git rev-parse HEAD~1)

            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please investigate logs and fix before retrying deployment.

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Notification (success)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [verify]
    if: success()

    steps:
      - name: Send success notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          subject: "âœ… Production Deployment Successful"
          to: benedetto.romano@studioromano.it
          from: deploy@studioromano.it
          body: |
            Deployment to production completed successfully!

            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Message: ${{ github.event.head_commit.message }}

            Application: https://romanoing.com
            Monitoring: http://${{ secrets.PRODUCTION_SERVER_IP }}:3001 (Grafana)

            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
