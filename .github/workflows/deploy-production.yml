name: Deploy to Production

# Trigger su push a production o develop branch
on:
  push:
    branches:
      - production
      - develop
  workflow_dispatch:  # Permette trigger manuale da UI GitHub

env:
  NODE_VERSION: '20'
  ANSIBLE_VERSION: '9.12.0'

jobs:
  # ═══════════════════════════════════════════════════════
  # JOB 1: Test e Build (CI)
  # ═══════════════════════════════════════════════════════

  test:
    name: Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: studio-erp/package-lock.json

      - name: Install dependencies
        working-directory: studio-erp
        run: npm ci

      - name: Lint code
        working-directory: studio-erp
        run: npm run lint
        continue-on-error: true  # Non blocca deploy per warning lint

      - name: Generate Prisma Client
        working-directory: studio-erp
        run: npx prisma generate

      - name: Build Next.js
        working-directory: studio-erp
        run: npm run build
        env:
          # Build-time env vars necessarie per Next.js build
          DATABASE_URL: "postgresql://test:test@localhost:5432/test?schema=public"
          NEXTAUTH_SECRET: "test-secret-min-32-characters-long-for-build"
          NEXTAUTH_URL: "https://romanoing.com"
          STRIPE_SECRET_KEY: "sk_test_mock_for_build"
          STRIPE_WEBHOOK_SECRET: "whsec_mock_for_build"
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: "pk_test_mock_for_build"
          SENDGRID_API_KEY: "SG.mock_for_build"
          EMAIL_FROM: "test@test.com"
          NEXT_PUBLIC_APP_URL: "https://romanoing.com"
          NEXT_PUBLIC_APP_NAME: "Studio Ing. Romano"
          NODE_ENV: "production"
          # Public env vars
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: |
            studio-erp/.next
            studio-erp/node_modules
          retention-days: 1

  # ═══════════════════════════════════════════════════════
  # JOB 2: Security Scan (SAST)
  # ═══════════════════════════════════════════════════════

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --file=studio-erp/package.json
        continue-on-error: true  # Non blocca deploy (solo alert)

      - name: Run npm audit
        working-directory: studio-erp
        run: |
          npm audit --audit-level=high || echo "npm audit found vulnerabilities"
        continue-on-error: true

  # ═══════════════════════════════════════════════════════
  # JOB 3: Deploy con Ansible (CD)
  # ═══════════════════════════════════════════════════════

  deploy:
    name: Deploy to Hetzner
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    environment: production  # Require manual approval (GitHub Environment protection rules)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          ansible --version

      - name: Install Ansible Galaxy collections
        run: |
          ansible-galaxy collection install community.general
          ansible-galaxy collection install community.postgresql
          ansible-galaxy collection install ansible.posix

      - name: Configure SSH key  
        env:
          SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # Install expect for automation
          sudo apt-get update && sudo apt-get install -y expect
          
          # Start ssh-agent and export variables for subsequent steps
          eval "$(ssh-agent -s)"
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> $GITHUB_ENV
          
          # Add key to ssh-agent with passphrase using sshpass
          echo "$SSH_PASSPHRASE" | ssh-add ~/.ssh/id_ed25519
          
          # Test SSH key
          ssh-keygen -l -f ~/.ssh/id_ed25519 || echo "SSH key validation failed"
          
          # Add server to known_hosts
          echo "Adding server to known_hosts..."
          timeout 10 ssh-keyscan -H -p 22 ${{ secrets.PRODUCTION_SERVER_IP }} >> ~/.ssh/known_hosts || {
            echo "ssh-keyscan failed, adding server manually to known_hosts"
            echo "${{ secrets.PRODUCTION_SERVER_IP }} ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC..." >> ~/.ssh/known_hosts
          }
          
          # Test SSH connection (should work with ssh-agent)
          echo "Testing SSH connection..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no root@${{ secrets.PRODUCTION_SERVER_IP }} "echo 'SSH connection successful'" || echo "SSH connection test failed"

      - name: Create Ansible Vault password file
        run: |
          if [ -n "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" ]; then
            echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > studio-erp/ansible/.vault_pass
            chmod 600 studio-erp/ansible/.vault_pass
          else
            echo "No vault password provided, creating dummy file"
            echo "dummy" > studio-erp/ansible/.vault_pass
            chmod 600 studio-erp/ansible/.vault_pass
          fi

      - name: Create vault file (unencrypted for MVP)
        run: |
          mkdir -p studio-erp/ansible/group_vars/production
          cat > studio-erp/ansible/group_vars/production/vault.yml << 'EOF'
          ---
          vault_postgresql_password: temp_password_123
          vault_nextauth_secret: temp_secret_32_chars_long_for_mvp_only
          vault_nextauth_url: https://romanoing.com
          vault_stripe_publishable_key: pk_test_temp
          vault_stripe_secret_key: sk_test_temp  
          vault_stripe_webhook_secret: whsec_temp
          vault_sendgrid_api_key: SG.temp
          vault_openai_api_key: ""
          vault_upstash_redis_rest_url: ""
          vault_upstash_redis_rest_token: ""
          vault_sentry_dsn: ""
          vault_hetzner_api_token: ""
          vault_backup_encryption_passphrase: temp_backup_pass
          vault_grafana_admin_password: temp_grafana_pass
          EOF

      - name: Update inventory with server IP
        run: |
          sed -i "s/XXX.XXX.XXX.XXX/${{ secrets.PRODUCTION_SERVER_IP }}/g" studio-erp/ansible/inventory/production.yml

      - name: Debug SSH connection before Ansible
        run: |
          echo "=== SSH Agent Status ==="
          ssh-add -l || echo "No keys in ssh-agent"
          
          echo "=== Testing direct SSH connection ==="
          echo "Testing port 22..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -v root@${{ secrets.PRODUCTION_SERVER_IP }} "echo 'SSH test successful'" || echo "Port 22 failed"
          
          echo "Testing port 2222..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -p 2222 -v root@${{ secrets.PRODUCTION_SERVER_IP }} "echo 'SSH test successful'" || echo "Port 2222 failed"
          
          echo "=== Port scan ==="
          nmap -p 22,2222 ${{ secrets.PRODUCTION_SERVER_IP }} || echo "nmap not available"
          
          echo "=== Basic connectivity check ==="
          ping -c 2 ${{ secrets.PRODUCTION_SERVER_IP }} || echo "Ping failed"
          
          echo "=== TCP connectivity check ==="
          timeout 5 telnet ${{ secrets.PRODUCTION_SERVER_IP }} 22 || echo "Port 22 not reachable"
          
          echo "=== Testing Ansible connection ==="
          cd studio-erp/ansible
          ansible studio-erp-prod -m ping -v

      - name: Run Ansible deployment (application only)
        working-directory: studio-erp/ansible
        run: |
          ansible-playbook playbooks/application.yml \
            --extra-vars "app_user=studio app_name=studio-erp app_group=studio app_directory=/var/www/studio-erp app_repository=https://github.com/romanobenit/romanoing.git app_repository_branch=production postgresql_database=studio_erp postgresql_user=studio_user postgresql_port=5432" \
            --tags deploy \
            -v

      - name: Health check
        run: |
          sleep 10  # Attendi avvio applicazione
          curl --fail --retry 3 --retry-delay 5 https://romanoing.com/api/health

      - name: Notify Sentry deployment
        if: success()
        run: |
          curl -X POST https://sentry.io/api/0/organizations/studio-romano/releases/ \
            -H "Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "${{ github.sha }}",
              "projects": ["studio-erp"],
              "refs": [{
                "repository": "${{ github.repository }}",
                "commit": "${{ github.sha }}"
              }]
            }' || echo "Sentry notification failed (non-blocking)"

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f studio-erp/ansible/.vault_pass
          rm -f studio-erp/ansible/group_vars/production/vault.yml
          rm -f ~/.ssh/id_ed25519

  # ═══════════════════════════════════════════════════════
  # JOB 4: Post-Deployment Verification
  # ═══════════════════════════════════════════════════════

  verify:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for application warmup
        run: sleep 15

      - name: Test public endpoints
        run: |
          # Homepage
          curl -f -s -o /dev/null -w "%{http_code}" https://romanoing.com | grep "200"

          # Health check
          curl -f https://romanoing.com/api/health

          # Bundle catalog API (public)
          curl -f https://romanoing.com/api/bundle

      - name: Test SSL/TLS configuration
        run: |
          # Verifica certificato SSL valido
          openssl s_client -connect romanoing.com:443 -servername romanoing.com < /dev/null 2>/dev/null | \
            openssl x509 -noout -dates

          # Verifica TLS 1.2+
          curl -v --tlsv1.2 https://romanoing.com 2>&1 | grep "TLSv1.[23]"

      - name: Test security headers
        run: |
          # HSTS
          curl -s -I https://romanoing.com | grep -i "strict-transport-security"

          # X-Frame-Options
          curl -s -I https://romanoing.com | grep -i "x-frame-options"

          # X-Content-Type-Options
          curl -s -I https://romanoing.com | grep -i "x-content-type-options"

      - name: Run Lighthouse CI (performance)
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://romanoing.com
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ═══════════════════════════════════════════════════════
  # JOB 5: Rollback (solo su fallimento)
  # ═══════════════════════════════════════════════════════

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history per rollback

      - name: Setup Python & Ansible
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: pip install ansible==${{ env.ANSIBLE_VERSION }}

      - name: Configure SSH
        env:
          SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # Install expect and setup ssh-agent for rollback
          sudo apt-get update && sudo apt-get install -y expect
          eval "$(ssh-agent -s)"
          
          # Add key with passphrase
          expect -c "
          spawn ssh-add ~/.ssh/id_ed25519
          expect \"Enter passphrase\"
          send \"$SSH_PASSPHRASE\r\"
          expect eof
          "
          
          ssh-keyscan -H ${{ secrets.PRODUCTION_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Rollback to previous commit
        run: |
          PREVIOUS_COMMIT=$(git rev-parse HEAD~1)
          echo "Rolling back to commit: $PREVIOUS_COMMIT"

          ssh root@${{ secrets.PRODUCTION_SERVER_IP }} << EOF
            cd /var/www/studio-erp
            sudo -u studio git checkout $PREVIOUS_COMMIT
            sudo -u studio npm ci
            sudo -u studio npx prisma generate
            sudo -u studio npm run build
            sudo -u studio pm2 restart studio-erp
          EOF

      - name: Verify rollback
        run: |
          sleep 10
          curl --fail https://romanoing.com/api/health

      - name: Notify team of rollback
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          subject: "⚠️ Production Deployment Failed - Rollback Executed"
          to: benedetto.romano@studioromano.it
          from: deploy@studioromano.it
          body: |
            Deployment to production FAILED and automatic rollback was executed.

            Failed commit: ${{ github.sha }}
            Rolled back to: $(git rev-parse HEAD~1)

            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please investigate logs and fix before retrying deployment.

# ═══════════════════════════════════════════════════════
# Notification (success)
# ═══════════════════════════════════════════════════════

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [verify]
    if: success()

    steps:
      - name: Send success notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          subject: "✅ Production Deployment Successful"
          to: benedetto.romano@studioromano.it
          from: deploy@studioromano.it
          body: |
            Deployment to production completed successfully!

            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Message: ${{ github.event.head_commit.message }}

            Application: https://romanoing.com
            Monitoring: http://${{ secrets.PRODUCTION_SERVER_IP }}:3001 (Grafana)

            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
