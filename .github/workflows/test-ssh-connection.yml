name: Test SSH Connection

# Workflow semplificato per testare SOLO la connessione SSH
# Trigger manuale per debugging

on:
  workflow_dispatch:  # Solo trigger manuale

jobs:
  test-ssh:
    name: Test SSH Connection
    runs-on: ubuntu-latest
    
    steps:
      - name: Test basic connectivity
        run: |
          echo "=== Testing basic connectivity ==="
          ping -c 3 116.203.109.249
          
          echo "=== Testing SSH port ==="
          nc -zv 116.203.109.249 22
          
          echo "=== Getting SSH host keys ==="
          ssh-keyscan -p 22 116.203.109.249
      
      - name: Setup SSH with verbose debugging
        run: |
          echo "=== Setting up SSH key ==="
          mkdir -p ~/.ssh
          
          # Check if SSH_PRIVATE_KEY exists and is valid
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå ERROR: SSH_PRIVATE_KEY secret not set!"
            exit 1
          fi
          
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # Validate SSH key format
          if ! ssh-keygen -l -f ~/.ssh/id_ed25519; then
            echo "‚ùå ERROR: Invalid SSH private key format!"
            exit 1
          fi
          
          echo "‚úÖ SSH key format is valid"
          
      - name: Test SSH connection (no passphrase)
        run: |
          echo "=== Adding host to known_hosts ==="
          ssh-keyscan -H 116.203.109.249 >> ~/.ssh/known_hosts
          
          echo "=== Testing SSH connection (no agent) ==="
          timeout 30 ssh -vvv -i ~/.ssh/id_ed25519 \
            -o ConnectTimeout=30 \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o PreferredAuthentications=publickey \
            root@116.203.109.249 \
            "echo 'SSH connection successful!'" || {
              echo "‚ùå SSH connection failed with exit code $?"
              echo "This usually means:"
              echo "1. Wrong SSH private key in secrets"
              echo "2. Key has passphrase but none provided"  
              echo "3. Server SSH config doesn't accept this key"
              exit 1
            }
            
      - name: Test SSH connection (with ssh-agent)
        run: |
          echo "=== Testing with ssh-agent ==="
          eval "$(ssh-agent -s)"
          
          # Try to add key without passphrase first
          if ssh-add ~/.ssh/id_ed25519 2>/dev/null; then
            echo "‚úÖ SSH key added without passphrase"
          else
            echo "‚ö†Ô∏è  SSH key requires passphrase"
            
            # Try with passphrase if provided
            if [ -n "${{ secrets.SSH_PASSPHRASE }}" ]; then
              echo "Trying with provided passphrase..."
              sudo apt-get install -y expect
              expect -c "
              spawn ssh-add ~/.ssh/id_ed25519
              expect \"Enter passphrase\"
              send \"${{ secrets.SSH_PASSPHRASE }}\r\"
              expect eof
              " || {
                echo "‚ùå Failed to add SSH key with passphrase"
                exit 1
              }
            else
              echo "‚ùå No SSH_PASSPHRASE secret provided but key requires one"
              exit 1
            fi
          fi
          
          echo "=== Testing connection with ssh-agent ==="
          timeout 30 ssh -o ConnectTimeout=30 \
            -o StrictHostKeyChecking=no \
            root@116.203.109.249 \
            "echo 'SSH connection with agent successful!'"
            
      - name: Test server commands
        run: |
          echo "=== Testing basic server commands ==="
          ssh -o StrictHostKeyChecking=no root@116.203.109.249 << 'EOF'
            echo "Server info:"
            uname -a
            uptime
            df -h /
            
            echo "SSH service status:"
            systemctl status ssh --no-pager
            
            echo "Recent SSH connections:"
            tail -10 /var/log/auth.log | grep sshd || echo "No recent SSH logs"
          EOF
          
      - name: Connection summary
        if: always()
        run: |
          echo "=== SSH CONNECTION TEST SUMMARY ==="
          echo "‚úÖ Server is reachable (ping OK)"
          echo "‚úÖ SSH port 22 is open"
          echo "‚úÖ SSH service is responding"
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ SSH authentication successful"
            echo "üëâ You can now run the full deployment workflow!"
          else
            echo "‚ùå SSH authentication failed"
            echo "üëâ Check SERVER-DIAGNOSIS.md for troubleshooting steps"
            echo "üëâ Most likely: wrong SSH key in GitHub secrets"
          fi